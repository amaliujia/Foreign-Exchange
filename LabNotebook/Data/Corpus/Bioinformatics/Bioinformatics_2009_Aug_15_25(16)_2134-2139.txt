1 INTRODUCTION
The reconstruction of genealogical relationships among diploid species has been an active field of research for more than three decades. A well-developed statistical theory of paternity inference has been published in series of articles by E. A. Thompson (e.g. Thompson, ). The study of parentage in natural populations was the topic of the pioneering papers by Meagher and Thompson () and Marshall et al. () and is recently reviewed in Blouin (); Jones and Ardren (); Pemberton (). The pedigree structure of a sample of individuals is important for a wide range of ecological, evolutionary and forensic studies. Applications include genealogy reconstruction (e.g. for wine grape cultivars Vouillamoz and Grando, ), the estimation of heritabilities in the wild (Thomas and Hill, ) and victim identification (Lin et al., ).

In order to reconstruct the pedigree of a sample, the parents of each individual in the sample need to be determined. If one has a large amount of genomic data, the task of identifying first degree relationships, i.e. parent‚Äìoffspring and full-sibs relations, is trivial. Unfortunately, many datasets in natural populations do not contain enough information to unambiguously determine the parents. Another problem is that datasets often contain only a subset of a population. Thus, one or both parents of an observed individual may be missing from the dataset. Furthermore, many datasets are not free of errors.

Most programs support only datasets comprising one or two generations. The approach to partial pedigree reconstruction in one generation datasets are sibship algorithms. Here, genotype data is used to infer full-sib and half-sib relationships (Berger-Wolf et al., ; Thomas and Hill, ; Wang, ). The parentage inference programs for two generations typically take an offspring list, if known their mothers, and a list of candidate parents or fathers as input and generate the possible parent combinations (Hadfield et al., ; Kalinowski et al., ). Much less attention (e.g. in Almudevar, ) has been given to multi-generation pedigrees in which the offspring and candidate parent sets are not necessarily non-overlapping. This is the case, for example, in the absence of age data. Then the ordering of genotypes into generations is not known a priori and has to be estimated from the genotype data only. Thus, at difference with parentage inference programs, the general case treated also here does not admit all possible parentage combinations as valid pedigrees. The task is therefore to find the parentage combinations that define the maximum likelihood pedigree. If the number of possible pedigrees is too large too enumerate, heuristics are necessary. So far, a flexible software package has not been available that allows the incorporation of prior information in addition to the genotypes and that is robust in the case of errors. It is the purpose of this contribution to fill this gap.

2 DEFINITIONS
A pedigree ùí´=(V, A) is an acyclic digraph with vertex set V and arc set A. For an arc (ui, v) we say that v is a child of ui and ui is a parent of v. The set of (putative) parents of v is denoted by N+(v)‚äÜV; it may have cardinality 2 {ui, uj}, 1 {ui} or 0 ‚àÖ. In the latter case, v is called a founder. In selfing species, ui=uj is allowed and ùí´ is a multigraph. The set of all valid parent combinations of v is denoted by ‚Ñã(v). Again we include the cases that none or only one of the parents are present in V. Note that ‚Ñã(v)‚äÇV √ó V‚à™V‚à™{‚àÖ}. The Mendelian laws of inheritance and prior information such as sex, age and known mothers restrict ‚Ñã(v).

For each individual, we have to choose one parent combination N+(v)‚àà‚Ñã(v). Not all such combinations of parents are possible, because this may introduce directed cycles into the pedigree. ùíØ denotes the set of all valid pedigrees.

For a given individual i, we denote an observed single-locus genotype by gi and its multi-locus genotype by Gi.

3 BACKGROUND
3.1 LOD scores
Consider a triplet of individuals (A, B, C) with single-locus genotypes gA, gB and gC. In likelihood-based paternity analyses, one compares the likelihood of the hypothesis (H1) that the three individuals are offspring, mother and father, with the likelihood of the alternative hypothesis (H2) that the three individuals are unrelated. This comparison is usually expressed as a log-ratio, the parent-pair log-odds ratio (LOD) score (e.g. Meagher and Thompson, ):



The likelihood of (H2) is the probability of observing the three genotypes when randomly drawn from a population in Hardy‚ÄìWeinberg equilibrium. For diploid heterozygotes, the probability of a genotype with the alleles a1 and a2 and with the allele frequencies p and q is Pr(a1, a2)=2pq; for homozygotes, we have Pr(a1, a1)=p2. The Mendelian transmission probability is denoted by T(¬∑). Variations of this equation can be derived for the cases where only one parent is sampled (single-parent LOD scores) and for triples where the relationship of two individuals A and B, typically mother and offspring, is known (Kalinowski et al., ; Meagher and Thompson, ).

3.2 Statistical significance of a parentage
Different ways of assessing the confidence of the parentage with the largest LOD score have been proposed. Marshall et al. () use ŒîLOD as test statistic, which is the difference of the LOD scores between the two most likely parentages. The critical value of this test statistic is obtained by simulation. If not all individuals of the population are sampled, then the total number of breeding individuals N in the population must be estimated and incorporated in the simulation. Nielsen et al. () proposed a Bayesian approach, extending the fractional paternity approach suggested by Devlin et al. (). The posterior probability that male Fi is the father of O can now be calculated for the case when the mother M is known as

where GO, GM and GF are the offspring, maternal and paternal genotypes, A the population allele frequencies and n the number of sampled males. So (N ‚àí n) weights the case that the true father is unsampled accordingly. Ignoring this weighting will give many false matches when the sampling rate and the amount of genomic information is low (Nielsen et al., ). In the following, we shortly write Pr(N+(vi)|A, N) for the parentage posterior probability of vertex vi.

For the case that the mother is unknown and assuming that the numbers of breeding males and females do not differ significantly, we have to add (N ‚àí n)2 Pr(GO|A) to the denominator to weight the case that both parents are unsampled.

One important advantage of this Bayesian approach over the simulation approach is that for the case that N is not known with high confidence, it is possible to estimate this value simultaneously with the pedigree reconstruction.

3.3 IBD coefficients
For each pair of individuals, we can calculate the probability that the two have a particular relationship ‚Ñù: unrelated ùïå, parent-‚àíoffspring ‚ÑôùïÜ, full-sib ùîΩùïä, half-sib ‚Ñçùïä, etc. The usual way of calculating the likelihoods Pr(gA.gB|‚Ñù) uses the so-called IBD (identical by descent) coefficients k0, k1 and k2. Alleles are IBD if they are identical and are segregated from a recent common ancestor. A child, for example, shares with each parent exactly one allele that is IBD (k1 = 1); monozygotic twins share two (k2 = 1) whereas unrelated individuals share no alleles (k0 = 1) IBD. For full-sibs, it is easy to show that the probability that they share one allele IBD is 0.5 and that they share no or two is in both cases 0.25 (so k0 = 0.25, k1 = 0.5 and k2 = 0.25). Given the allele frequencies, the probabilities that the genotype pair gA.gB shares 0, 1 or 2 alleles IBD, P0, P1 and P2, are then calculated and are inserted in the final IBD likelihood formula (for details, see e.g. Blouin, ):



For unlinked loci, which we assume in the following, the logarithms of the IBD relationship likelihoods and the LOD scores are additive over the loci.

3.4 Genotyping errors
Even high quality datasets contain errors where at least one allele at a given locus does not match with what we expect from the Mendelian laws. Thus, it is unwise to exclude a parent immediately when observing such a mismatch. There are many reasons for such mismatches, see Bonin et al. () for a review. Genotyping errors occur when the genotype determined by molecular analysis does not correspond to the real genotype. For instance, a common type of genotyping error in microsatellite datasets are null alleles, which are often the result of a mutation in the primer annealing site. Somatic mutations form another source of mismatches.

The model implemented here defines an error to be the replacement of the true genotype at a particular locus in an individual with a random genotype. This leads to a modification of the expressions for the LOD score, see Kalinowski et al. (), and to corresponding modifications in the IBD likelihood calculations, see Broman and Weber () for details.

4 METHODS
4.1 Simulation
Given the population allele frequencies and the expected typing error rate, which are either estimated using the sample itself or provided by the user, we generate individuals with known relationships to determine various distributions.

One important characteristic is the distribution of the number of mismatching loci given the expected error rate for pairs (parent‚Äìoffspring versus unrelated) as well for triples (offspring, mother and father versus offspring, mother and unrelated male). This knowledge allows us to speed up the algorithm, because we know when likelihood calculations can be terminated. We can furthermore omit the O(n3) triple calculation for pairs with more mismatches than maximally expected for a triple. These parameters are also important because too many allowed mismatches may lead to an increased number of false positive parent‚Äìoffspring arcs.

Furthermore, we will later test the null hypothesis that a pair is a full-sib against the alternative hypotheses that they are unrelated, parent‚Äìoffspring or half-sib. We calculate the P-values by generating following distributions for full-sibs and for pairs of the alternative hypothesis relationship:



So for example Œîpo is generated for full-sibs and parent‚Äìoffspring pairs to estimate the statistical significance of an observed positive Œîpo value. Note that ‚Ñçùïä are all second degree relationships (half-sib, grandparent‚Äìgrandoffspring and avuncular), which has to be considered in the P-value calculation.

4.2 Calculation of the possible parent‚Äìoffspring arcs
For every individual v, we calculate the LOD scores with all candidate parents ui, individuals we cannot exclude a priori as parents, for example, because of their age. We discard pairs (ui, v) or triples (ui, uj, v) with negative multi-locus LOD scores from our further analyses, because adding the corresponding arcs to the pedigree would decrease its likelihood. Hence, for every pair of individuals with positive single-parent LOD score, (ui, ?) is included in the set of valid parent combinations ‚Ñã(v), just as well (ui, uj) for every triple with positive parent-pair LOD score. Unless we know that at least one parent of v is sampled, we include the empty parent pair (?, ?) in ‚Ñã(v).

The parentage likelihood calculation is the most important step in the pedigree reconstruction procedure as these likelihoods define the set of all possible arcs in the pedigree. However, as described in detail in Thompson and Meagher (), if we cannot exclude two full-sibs, vi and vj, as parent and offspring, they in general give a higher likelihood than do true parents. Thus, for highly probable full-sibs, a reasonable strategy is to use only the intersection of the valid parent combinations: ‚Ñã(vi)=‚Ñã(vj)=‚Ñã(vi)‚à©‚Ñã(vj). The critical values of Œîpo and Œîhs that a full-sib pair must exceed should be high enough to prevent false positives, which may result in an exclusion of the true parents in the next step, the pedigree reconstruction. Note that if the intersection contains a parent pair, this is an additional hint that vi and vj are full-sibs. Modeling this in the P-value calculation is difficult, we could use however a less conservative critical Œ± value in this case. As default values for Œ±, we use 0.01 and 0.05, respectively. The observed P-values are adjusted for multiple testing (Benjamini and Hochberg, ).

4.3 Pedigree likelihood
The log-likelihood of a pedigree ùí´ is now computed as the sum of the logarithms of the NI parentage posterior probabilities given this pedigree:



We use simulated annealing (Kirkpatrick et al., ) for the pedigree reconstruction as described in Almudevar () to find the maximum likelihood pedigree. If necessary, then every NI+2 iterations a random missing value is estimated by Gibbs sampling.

4.4 Incomplete sampling
As already stated in , if not all candidate parents are sampled, it is important to estimate the number of unsampled candidates. This number could be either estimated by additional experiments, for example capture‚Äìrecapture surveys or by using the data alone. The pedigree structure itself contains information about the sampling rate in the ratio of the number vertices with indegree 1 and with indegree 2, d1 and d2:



For larger samples, setting x=1 should give a good point estimate of N when we assume that r and x are constant across sampled generations. Again every NI+2 iterations, we draw a new value of x from a flat distribution ùí∞(r, xmax) and accept the change with the simulated annealing acceptance probability. A value of 4 for xmax showed a very robust performance in our tests. Depending on the data, it might be also necessary to specify a Nmax (Nielsen et al., ). In the absence of age data, it is not known a priori which sampled individuals are candidate parents. So it might also be necessary here to specify n and to exclude at least the direct descendants in the parentage posterior calculation.

4.5 MCMC
When ùíØ does not allow all parentage combinations, the parentage posterior probabilities Pr(N+(vi)|A, N) () must be corrected accordingly. FRANz samples from the pedigree posterior distribution Pr(ùí´) by Markov Chain Monte Carlo (MCMC) and redefines Pr(N+(vi)) as the probability of observing the parentage N+(vi) when drawing from Pr(ùí´). Another benefit of MCMC sampling is that it allows to incorporate the uncertainty of the pedigree reconstruction when estimating parameters from the pedigrees (Hadfield et al., ).

To speed up mixing, FRANz automatically uses parallel Metropolis coupled Markov chain Monte Carlo (MCMCMC; Huelsenbeck and Ronquist, ), implemented in a shared memory programming model, when run on computers with multiple CPU cores. In short, in addition to the normal, unheated chain, n‚àí1 heated chains are started on the CPU cores 2,‚Ä¶, n and states are attempted to swap with a given probability. Swaps are then accepted with normal Metropolis‚ÄìHasting acceptance probability. Pedigrees are only sampled from the unheated chain.

4.6 Allele frequencies
The population allele frequencies are often unknown. If the sample size is large and family sizes are small, it is reasonable to assume that individuals are unrelated and then to use all genotypes for the estimation. If not, however, then this strategy will overestimate the frequency of rare alleles in large families. FRANz therefore updates the allele frequencies during SA optimization or MCMC sampling. This is computationally extensive, but it is not necessary to update after every change of the pedigree (Thomas and Hill, ).

5 RESULTS
5.1 Real microsatellite data
Our first dataset is a microsatellite dataset of the black tiger shrimp Penaeus monodon (Jerry et al., ). The true pedigree is known from direct observation. The dataset consists of 13 families with a total number of 85 individuals (of which 59 offspring), genotyped at seven highly polymorphic loci. For 10 individuals, alleles are missing at one locus. The error rate is very low, with only one observed mismatch.  shows the best pedigrees with and without full-sib calculation (). Full-sibs tend to have higher parentage likelihoods, but large full-sib groups greatly enhance the performance of our algorithm such that the accuracy of the reconstructed pedigree increases from 82.8 to 97.1%. A recent publication (Berger-Wolf et al., ) listed an accuracy rate of several sibling reconstruction methods ranging from 67.8 to 78.0% percent on the same dataset. Classic parentage inference programs such as CERVUS (Marshall et al., ), where the absence of age data violates main assumptions, assign statistical significant parentages to the parental genotypes even when the correct parameters (sampling rate, fraction of relatives in the candidate parents) are provided.
Reconstructed Penaeus monodon pedigree (). The white vertices are the parental genotypes, black the offspring genotypes. (a) without full-sib calculation. (b) with full-sib calculation.




5.2 Simulated data
We artificially generate population datasets as follows. A population of 100 unrelated founders is created by drawing genotypes independently with allele frequencies of 64 human microsatellites (Jin et al., ). Then we let individuals die, mate or marry according to rates extracted from the statistics of the German population (Federal Statistical Office, ). As mating partners or husbands, we only allow unrelated individuals. Married couples only mate with each other. We stop when the desired number of individuals is reached. In order to simulate typing errors, we replace the true allele with a random one. Null alleles are simulated in heterozygote genotypes by replacing the null allele with the other allele (ai.an becomes ai.ai). Homozygote genotypes are marked as missing.

We analyze the accuracy of the pedigree reconstruction as a function of the number of available loci, see . In all cases where the accuracy is below 1, the optimal pedigree from our algorithm has an even larger likelihood than the true one. Thus without exceptions, our algorithm finds a pedigree with at least the log-likelihood of the true pedigree (data not shown). The plots show that the reconstruction is robust even when the upper limit of the total number of breeding individuals per generation in the population Nmax was largely overestimated (164 versus 1000).
These plots visualize the results of the reconstruction of simulated pedigrees (). The various measurement are plotted as a function of the number of loci. The values are the median of 10 randomly generated pedigrees of size 1000, reconstructed with different combinations of available prior knowledge. The error bars indicate the first and third quartile. The dataset has a sampling rate of 0.5 (1000 of 2000 individuals sampled) and has an overall typing error rate of 0.01. In addition, the first locus comprises one null allele (pn=0.05). The pedigree depth ranges from 5 to 9 and the mean number of sampled candidate parents is 82. Nmax (see ) was largely overestimated set to 1000. (a) The accuracy of the maximum likelihood pedigree. (b) The proportion of incorrect (unfilled symbols) and correct parentages with a posterior probability &gt;0.95. (c) The sensitivity and specificity of the sibling calculation.



Age data is clearly the most informative prior knowledge. Knowledge about the sex rarely helps to exclude a false parentage mainly because mothers are sampled like all individuals with a rate of 0.5 and sex requires candidate parent pairs for exclusion. Thus, the knowledge of the sex does not resolve the difficult cases where the true parents are unsampled but a close relative (e.g. aunt or uncle) is sampled.

Without age data, the direction of a large fraction of parent‚Äìoffspring arcs cannot be determined, which explains the plateaus in the plots. These parentages are easily identified by their posterior probability which is typically near 0.5. In Nielsen et al. (), a parentage was assigned when the posterior probability was higher than 0.95.  visualizes the proportion of correct and incorrect assignments. In almost all cases, the proportion of wrongly assigned parentages was smaller than 0.01. These parentages are mainly the difficult cases mentioned above or false positives of the sibling calculation, whose sensitivity and specificity is plotted in c.

6 DISCUSSION
We have presented a new algorithm for the multi-generation pedigree reconstruction problem. The publicly available implementation is written in the C programming language and is platform-independent. The genealogy of datasets with thousands of individuals is typically reconstructed in a few minutes. Our implementation is flexible in incorporating additional data like age, sex, sampling locations, sub-pedigrees and allele frequencies. This was suggested in Almudevar () but not previously implemented in a publicly available software package. The reconstruction of large and deep pedigrees is highly accurate with only 10‚Äì15 polymorphic microsatellite loci. Our approach is to our knowledge the first one that combines paternity inference and sibship reconstruction.

In Almudevar (), some remaining challenges in the pedigree reconstruction problem were listed. These are the assumption that founders are unrelated, a better estimation of allele frequencies, linkage, support for typing errors or mutation and estimation of the error of the reconstruction procedure. FRANz makes significant progress in the latter two tasks by combining the error model described in Kalinowski et al. () with an MCMC sampling.

The error model, however, was criticized in the literature because of its simplicity. Other programs explicitly model special kinds of errors, for example null alleles and sample the true genotypes with an individual-by-individual Gibbs sampling (Hadfield et al., ; Wang, ). For multi-generation pedigrees, one has to sample over the family to ensure irreducibility of the Markov chain (Sheehan, ). For large pedigrees, this becomes very fast computationally infeasible and the gain is questionable. Extending the likelihood formulas in (Kalinowski et al., ) to model null alleles, however, could be a valuable extension if they occur at higher rates. Now, FRANz estimates the null allele frequency (Kalinowski and Taper, ) and warns the user when null alleles are likely to be present in the data.

Extensions of the LOD scores for linked loci when the linkage phase is known are proposed in Devlin et al. (). If the linkage phase and recombination rates are known with high accuracy, the incorporation of this prior information can significantly enhance the performance of the parentage assignments (Devlin et al., ). However, in most cases the linkage phase is unknown and has to be estimated jointly. Loose linkage of a small fraction of markers should not seriously bias multi-locus likelihood calculations (Meagher, ). Tightly linked loci in contrast, such as neighboring single nucleotide polymorphisms (SNPs), can be combined and treated as one single pseudolocus. In general, linked loci are less informative than unlinked ones and therefore the calculated LOD scores are too large. The best advice now is probably to avoid medium linked loci (Jones and Ardren, ).

The framework we have presented in this article may easily be extended to incorporate prior knowledge in the likelihood calculation (Neff et al., ). Currently, prior knowledge is only used to reduce the search space. For parentages, sampling locations and behavioural data have been successfully used to increase the parentage assignments in Hadfield et al. (). Priors about the pedigree structure (the expected inbreeding rates, number of offspring, etc.) might further improve the performance (Sheehan and Egeland, ). Information of this kind is oftentimes unknown a priori, however. In fact, these are parameters that one typically would like to infer from the reconstructed pedigrees.

Our implementation currently only allows co-dominant markers. In Gerber et al. (), the original LOD scores for co-dominant markers (Meagher and Thompson, ) were modified for dominant markers, such as amplified fragment length polymorphisms. Statistics for estimating pairwise relationships with dominant markers were proposed e.g. in Wang ().

Our incorporation of full-sib probabilities is a reaction to the concern expressed in Meagher and Thompson () that non-excluded full-sibs of the offspring have on average a higher LOD score than the true father. To keep the pedigree likelihood function simple and efficient to calculate, we use only highly significant full-sibs to reduce the pedigree space. It seems possible to include more siblings than just the highly significant ones into the pedigree likelihood calculation without the risk of excluding the true parents. Since such ‚Äòlocal‚Äô factors in the pedigree likelihood are also not very computationally intensive, we plan to explore this avenue in future work.

With the rapid progress and decay of cost in high-throughput sequencing techniques, it is just a matter of time until there are whole genomes of complete populations available. Large amounts of SNP data with high quality genetic maps will be therefore available, at least for some model organisms. The identification of parents with such an amount of data is a trivial task and the methods are well known (Boehnke and Cox, ). A challenging question is then how many unobserved generations we can reconstruct back in time [see Steel and Hein () and Thatte and Steel () for first results]. As we cannot expect an elegant solution to this problem, MCMC heuristics are promising tools for throwing some light on a population's immediate past.

ACKNOWLEDGEMENTS
We would like to thank Dean Jerry for the P.monodon dataset, the anonymous reviewers for many helpful comments and Elizabeth Thompson for elaborately answering our questions.

Funding: European Commission NEST Pathfinder [initiative on Complexity through project EDEN (Contract 043251)].

Conflict of Interest: none declared.

